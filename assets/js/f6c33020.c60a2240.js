"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6694],{14632:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>s,metadata:()=>i,toc:()=>d});var r=t(85893),o=t(11151);const s={},a="Retrieve Context Information",i={id:"server/rag/retrieve",title:"Retrieve Context Information",description:"If you're using the MongoDB Chatbot Server to perform RAG, you must retrieve",source:"@site/docs/server/rag/retrieve.md",sourceDirName:"server/rag",slug:"/server/rag/retrieve",permalink:"/chatbot/server/rag/retrieve",draft:!1,unlisted:!1,editUrl:"https://github.com/mongodb/chatbot/tree/main/docs/docs/server/rag/retrieve.md",tags:[],version:"current",frontMatter:{},sidebar:"main",previous:{title:"Pre-Process User Queries",permalink:"/chatbot/server/rag/preprocess"},next:{title:"Include References",permalink:"/chatbot/server/rag/references"}},c={},d=[{value:"The <code>FindContentFunc</code> Function",id:"the-findcontentfunc-function",level:2},{value:"Find Content with Atlas Vector Search",id:"find-content-with-atlas-vector-search",level:2},{value:"Boost Results",id:"boost-results",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"retrieve-context-information",children:"Retrieve Context Information"}),"\n",(0,r.jsx)(n.p,{children:"If you're using the MongoDB Chatbot Server to perform RAG, you must retrieve\ncontext information to include in your answer. The primary way of doing this\nis with semantic search."}),"\n",(0,r.jsxs)(n.p,{children:["You can add the information that you retrieve using the ",(0,r.jsx)(n.a,{href:"/chatbot/ingest/configure",children:"MongoDB RAG Ingest CLI"}),". Information retrieval is the single point of contact between the MongoDB RAG Ingest CLI and the MongoDB Chatbot Server."]}),"\n",(0,r.jsxs)(n.h2,{id:"the-findcontentfunc-function",children:["The ",(0,r.jsx)(n.code,{children:"FindContentFunc"})," Function"]}),"\n",(0,r.jsxs)(n.p,{children:["To perform semantic search, you must implement a ",(0,r.jsx)(n.a,{href:"/chatbot/reference/server/modules#findcontentfunc",children:(0,r.jsx)(n.code,{children:"FindContentFunc"})})," function. To see the default implementation\nusing Atlas Vector Search, refer to the following\n",(0,r.jsx)(n.a,{href:"#find-content-with-atlas-vector-search",children:"Find Content with Atlas Vector Search"})," section."]}),"\n",(0,r.jsxs)(n.p,{children:["Pass the ",(0,r.jsx)(n.code,{children:"FindContentFunc"})," to the ",(0,r.jsx)(n.a,{href:"/chatbot/reference/server/interfaces/MakeRagGenerateUserPromptParams#findcontent",children:(0,r.jsx)(n.code,{children:"MakeRagGenerateUserPromptParams.findContent"})})," property."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import { makeRagGenerateUserPrompt } from "mongodb-chatbot-server";\nimport { someFindContentFunc } from "./someFindContentFunc"; // example\n\nconst ragGenerateUserPrompt = makeRagGenerateUserPrompt({\n  findContent: someFindContentFunc,\n  // ...other config\n});\n'})}),"\n",(0,r.jsx)(n.h2,{id:"find-content-with-atlas-vector-search",children:"Find Content with Atlas Vector Search"}),"\n",(0,r.jsxs)(n.p,{children:["To use the MongoDB Chatbot Server with Atlas Vector Search for semantic search,\nyou can use the ",(0,r.jsx)(n.a,{href:"/chatbot/reference/server/modules#makedefaultfindcontentfunc",children:(0,r.jsx)(n.code,{children:"makeDefaultFindContentFunc()"})}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["This function retrieves data from an ",(0,r.jsx)(n.a,{href:"/chatbot/reference/core/modules#embeddedcontentstore",children:(0,r.jsx)(n.code,{children:"EmbeddedContentStore"})}),". To learn more about how to add data to an ",(0,r.jsx)(n.code,{children:"EmbeddedContentStore"}),", refer to the ",(0,r.jsx)(n.a,{href:"/chatbot/ingest/configure",children:"Ingest CLI documentation"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Pass a ",(0,r.jsx)(n.a,{href:"/chatbot/reference/server/modules#makedefaultfindcontentfuncargs",children:(0,r.jsx)(n.code,{children:"MakeDefaultFindContentFuncArgs"})})," object to the ",(0,r.jsx)(n.code,{children:"makeDefaultFindContentFunc()"})," function."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import { makeRagGenerateUserPrompt } from "mongodb-chatbot-server";\n\n// Create function that creates vector embeddings\n// for user query.\nconst embedder = makeOpenAiEmbedder({\n  openAiClient,\n  deployment: OPENAI_EMBEDDING_DEPLOYMENT,\n  backoffOptions: {\n    numOfAttempts: 3,\n    maxDelay: 5000,\n  },\n});\n\n// Data store that is used to store the vector embeddings.\n// Used to look up matching content.\nconst embeddedContentStore = makeMongoDbEmbeddedContentStore({\n  connectionUri: MONGODB_CONNECTION_URI,\n  databaseName: MONGODB_DATABASE_NAME,\n});\n\nconst args: MakeDefaultFindContentFuncArgs = {\n  embedder,\n  store: embeddedContentStore,\n  findNearestNeighborsOptions: {\n    k: 5,\n    path: "embedding",\n    indexName: VECTOR_SEARCH_INDEX_NAME,\n    // Note: you may want to adjust the minScore depending\n    // on the embedding model you use. We\'ve found 0.9 works well\n    // for OpenAI\'s text-embedding-ada-02 model for most use cases,\n    // but you may want to adjust this value if you\'re using a different model.\n    minScore: 0.9,\n  },\n};\nconst findContent = makeDefaultFindContentFunc(args);\n\nconst ragGenerateUserPrompt = makeRagGenerateUserPrompt({\n  findContent,\n  // ...other config\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"boost-results",children:"Boost Results"}),"\n",(0,r.jsxs)(n.p,{children:["You can modify the results returned by the default find content function with\n",(0,r.jsx)(n.a,{href:"/chatbot/reference/server/interfaces/SearchBooster",children:(0,r.jsx)(n.code,{children:"SearchBooster"})})," objects.\n",(0,r.jsx)(n.code,{children:"SearchBooster"}),"s mutate the results returned by the default find content function."]}),"\n",(0,r.jsxs)(n.p,{children:["You could use a ",(0,r.jsx)(n.code,{children:"SearchBooster"})," to do things like:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Always results from a specific data source"}),"\n",(0,r.jsx)(n.li,{children:"Ensure a data source isn't over-represented in the results"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["To use one or more ",(0,r.jsx)(n.code,{children:"SearchBooster"}),"s, pass them to the ",(0,r.jsx)(n.code,{children:"MakeDefaultFindContentFuncArgs.searchBoosters"})," property. The ",(0,r.jsx)(n.code,{children:"searchBoosters"})," property is an array of ",(0,r.jsx)(n.code,{children:"SearchBooster"})," objects, which are applied in the order of the array."]}),"\n",(0,r.jsxs)(n.p,{children:["The following is an example of using a ",(0,r.jsx)(n.code,{children:"SearchBooster"})," to ensure that results from a specific data source are always returned."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"/**\n * Ensure that results from data source 'foo' are always returned\n * if query contains 'foo'.\n */\nconst boostFoo: SearchBooster = {\n  async shouldBoostFunc({ text }: { text: string }) {\n    return text.includes(\"foo\");\n  },\n  async boost({\n    embedding,\n    store,\n    existingResults,\n  }: {\n    embedding: number[];\n    store: EmbeddedContentStore;\n    existingResults: WithScore<EmbeddedContent>[];\n  }) {\n    const boostedResults = await store.findNearestNeighbors(\n      embedding,\n      {\n        k: 2,\n        path: \"embedding\",\n        indexName: VECTOR_SEARCH_INDEX_NAME,\n        minScore: 0, // no min score for 'foo'\n      },\n      {\n        filter: {\n          dataSource: \"foo\",\n        },\n      }\n    );\n    const fewerExistingResults = existingResults.slice(0, 3);\n    // No duplicates\n    const newResults = fewerExistingResults.filter((result) =>\n      boostedResults.every((manualResult) => manualResult.text !== result.text)\n    );\n    //\n    return [...boostedResults, ...fewerExistingResults].sort(\n      (a, b) => b.score - a.score\n    );\n  },\n};\n\nconst args: MakeDefaultFindContentFuncArgs = {\n  // ...other args\n  searchBoosters: [boostFoo],\n};\n"})}),"\n",(0,r.jsxs)(n.admonition,{title:"Include Search Booster Filters In Your Atlas Vector Search Index",type:"note",children:[(0,r.jsxs)(n.p,{children:["If you are using an Atlas Vector Search filter in a booster,\nyou must include the filter in your index definition. For more information on Atlas Vector Search filters,\nrefer to ",(0,r.jsx)(n.a,{href:"https://www.mongodb.com/docs/atlas/atlas-vector-search/vector-search-type/#about-the-filter-type",children:"Atlas Vector Search filter index definition"}),"\nin the MongoDB Atlas documentation."]}),(0,r.jsxs)(n.p,{children:["For example, you might have a booster that finds data from a specific\ndata source by including a filter on a field named ",(0,r.jsx)(n.code,{children:"sourceName"})," during\nvector search. For the search to run, you must include the ",(0,r.jsx)(n.code,{children:"dataSource"}),"\nfield and any other filtered fields in your vector search index\ndefinition:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'{\n  "fields": [\n    {\n      "type": "vector"\n      // ...\n    },\n    {\n      "type": "filter",\n      "path": "sourceName"\n    }\n    // ...\n  ]\n}\n'})}),(0,r.jsxs)(n.p,{children:["Then you can include the filter in the ",(0,r.jsx)(n.code,{children:"$search"})," query in your booster."]})]})]})}function l(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>i,a:()=>a});var r=t(67294);const o={},s=r.createContext(o);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);